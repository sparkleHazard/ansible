---
# ansible/roles/base/tasks/main.yml

# Ensure rsync is installed for different operating systems.

- name: Ensure rsync is installed on Debian/Ubuntu
  package:
    name: rsync
    state: present
  when: ansible_os_family == "Debian"
  become: True

- name: Ensure rsync is installed on RedHat/CentOS/Fedora
  package:
    name: rsync
    state: present
  when: ansible_os_family == "RedHat"
  become: True

- name: Ensure rsync is installed on macOS using Homebrew
  community.general.homebrew:
    name: rsync
    state: present
  when: ansible_os_family == "Darwin"

# Fallback for systems that are not Darwin or Linux (if needed)
- name: Update system packages on non-Homebrew systems
  package:
    name:
      - curl
      - git
      - vim
      - htop
    state: latest
  when: ansible_os_family not in ["Darwin", "Linux"]
  become: True

# Ensure zsh is installed

- name: Install zsh on Debian/Ubuntu
  package:
    name: zsh
    state: present
  when: ansible_os_family == "Debian"
  become: True

- name: Install zsh on RedHat/CentOS/Fedora
  package:
    name: zsh
    state: present
  when: ansible_os_family == "RedHat"
  become: True

- name: Install zsh on Darwin (macOS) using Homebrew
  community.general.homebrew:
    name: zsh
    state: present
  when: ansible_os_family == "Darwin"
  become: True

# Set the default shell to zsh for the target user
#
# You can define a variable 'target_user' (for example, in host_vars or defaults)
# that specifies which user should have zsh as the default shell.
#
# Here, we use the ansible_env.USER variable if it's not root.
- name: Set default shell to zsh for target user
  user:
    name: "{{ target_user }}"
    shell: /bin/zsh
  vars:
    # If not defined elsewhere, default to ansible_env.USER
    target_user: "{{ (ansible_env.USER | default('')) | lower }}"
  when: target_user != 'root' and target_user != ""
  become: True

- name: Enable passwordless sudo for target user (if not root)
  copy:
    content: "{{ sudo_user }} ALL=(ALL) NOPASSWD: ALL"
    dest: "/etc/sudoers.d/{{ sudo_user }}"
    owner: root
    group: root
    mode: "0440"
  become: True
  when: sudo_user != ""

- name: Run 'mise install' command
  shell: /home/linuxbrew/.linuxbrew/bin/mise install
  register: mise_use_result
  changed_when: false
  when: host_role | default('base') != "keyserver"

- name: Install qemu-guest-agent if running in a QEMU/KVM virtual machine
  package:
    name: qemu-guest-agent
    state: present
  when: (ansible_virtualization_role == "guest") and (ansible_virtualization_type in ["qemu", "kvm"])
